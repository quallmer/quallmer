---
title: "The quallmer trace"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

The quallmer trace system automatically captures the complete history of your coding workflow, including model parameters, timestamps, and parent-child relationships. This enables full workflow traceability and reproducibility. It also allows you to assess the robustness of your findings across different models and settings. Lastly, it facilitates easy sharing of your analysis with collaborators. Altogether, the trace system provides a lightweight yet powerful way to provide full traceability for your AI-assisted qualitative coding projects.

## Why use the quallmer trace?

The quallmer trace helps you:

- Document your complete analysis workflow
- Track which models and settings were used
- Assess whether findings are robust across different models
- Share reproducible workflows with collaborators

## Basic example

```{r basic-example}
library(quallmer)

# Initial coding run
coded1 <- qlm_code(texts,
                   codebook = my_codebook,
                   model = "openai/gpt-4o",
                   name = "gpt4o_run")

# Replicate with different model (automatically tracks parent)
coded2 <- qlm_replicate(coded1,
                        model = "openai/gpt-4o-mini",
                        name = "mini_run")

# Extract and view the complete workflow trace
trace <- qlm_trace(coded1, coded2)
print(trace)
```

The trace shows the complete lineage: which models were used, when they ran, and how they relate to each other.

## Easy and quick workflow documentation

The `qlm_trace` function lets you extract, save, export, and generate reports in a single line:

```{r convenience}
# Document entire workflow in one call
qlm_trace(coded1, coded2,
          save = "workflow.rds",
          export = "workflow.json",
          report = "workflow.qmd")
```

This creates:

- **workflow.rds**: Complete trace object for R 
- **workflow.json**: Portable metadata for archival 
- **workflow.qmd**: Human-readable report you can render to HTML/PDF 

## Including comparison and validation results

If you've compared or validated your coding, include those objects to capture the full workflow:

```{r with-comparisons}
# Compare two coding runs
comparison <- qlm_compare(coded1, coded2, by = sentiment, level = "nominal")

# Include comparison in trace and generate comprehensive report
qlm_trace(coded1, coded2, comparison,
          report = "full_workflow.qmd",
          include_comparisons = TRUE)
```

The report will include inter-rater reliability metrics alongside the workflow timeline.

## Checking robustness

Use `qlm_trace_robustness()` to assess whether your substantive findings change across different models:

```{r robustness}
# Define your downstream analysis
my_analysis <- function(coded) {
  list(
    prop_positive = mean(coded$sentiment == "positive", na.rm = TRUE),
    mean_score = mean(coded$score, na.rm = TRUE)
  )
}

# Compare results across models
robustness <- qlm_trace_robustness(coded1, coded2,
                                   reference = "gpt4o_run",
                                   analysis_fn = my_analysis)

print(robustness)
```

The output shows:

- How much each statistic differs from the reference run 
- Absolute and percentage differences 
- Whether your conclusions are stable across models 

**Interpretation:**

- < 1% difference: Highly robust findings 
- 1-5% difference: Good robustness 
- 5-10% difference: Moderate robustness 
- \> 10% difference: Findings may be sensitive to model choice 

## Archiving with result data

By default, traces store metadata only (lightweight). To archive the complete coded results:

```{r with-data}
# Include actual coded data for complete archival
qlm_trace(coded1, coded2,
          include_data = TRUE,
          save = "complete_archive.rds")
```

This creates a self-contained archive of your entire workflow, perfect for replication packages or long-term storage.

## Summary

The trace system provides workflow traceability with minimal effort:

1. **Automatic tracking**: Every `qlm_code()` and `qlm_replicate()` captures provenance
2. **Simple extraction**: `qlm_trace()` reconstructs your workflow history
3. **One-line documentation**: Use convenience parameters for instant documentation
4. **Robustness checks**: Test if findings are stable across models

Always name your runs with the `name` parameter to make traces easier to interpret.
