---
title: "Example: Sentiment analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The `qlm_code()` function with the built-in `codebook_sentiment()` codebook allows you to rate the sentiment of texts using an LLM. The built-in `codebook_sentiment()` codebook structures the response with a numeric sentiment score from -1 (very negative) to 1 (very positive) and a brief explanation. 

### Loading packages and data

```{r getting-started}
library(quallmer)

#Example texts
texts <- c(
"This is wonderful!",
"I really dislike this approach.",
"The results are somewhat disappointing.",
"Absolutely fantastic work!"
)
```

### Using `qlm_code()` for built-in sentiment analysis of texts

```{r sentiment}
# Apply built-in sentiment codebook with codebook_sentiment() in the qlm_code() function
result <- qlm_code(texts, codebook = codebook_sentiment(),
                   model = "openai/gpt-4o",
                   temperature = 0)
```


```{r display_results2, echo = FALSE}
# sentiment analysis results table
library(kableExtra)
result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3) 
```

### Adjusting the sentiment task

You can customize the sentiment analysis task by defining your own codebook with `qlm_codebook()` (for a more detailed explanation, [see our "Defining custom codebooks" tutorial](https://seraphinem.github.io/quallmer/articles/pkgdown/tutorials/custom-codebook.html)).

For example, you might want to include an additional field for confidence level.
```{r custom_sentiment}
custom_sentiment <- qlm_codebook(
  name = "Custom sentiment analysis",
  instructions = "Rate the sentiment of each text from -1 (very negative) to 1 (very positive), briefly explain why, and provide a confidence level from 0 to 1.",
  schema = ellmer::type_object(
    score = ellmer::type_number("Sentiment score between -1 (very negative) and 1 (very positive)"),
    explanation = ellmer::type_string("Brief explanation of the rating"),
    confidence = ellmer::type_number("Confidence level from 0 to 1")
  ),
  role = "You are an expert annotator.",
  input_type = "text"
)
# Apply the custom sentiment codebook
custom_result <- qlm_code(texts, codebook = custom_sentiment,
                          model = "openai/gpt-4o",
                          temperature = 0)
```
```{r display_results_custom, echo = FALSE}
# sentiment analysis results table
library(kableExtra)
custom_result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3) 
```
Or, you might want to change the scoring scale to a 5-point Likert scale.
```{r likert_sentiment}
likert_sentiment <- qlm_codebook(
  name = "Likert scale sentiment analysis",
  instructions = "Rate the sentiment of each text on a scale from 1 (very negative) to 5 (very positive) and briefly explain why.",
  schema = ellmer::type_object(
    score = ellmer::type_number("Sentiment score between 1 (very negative) and 5 (very positive)"),
    explanation = ellmer::type_string("Brief explanation of the rating")
  ),
  role = "You are an expert annotator.",
  input_type = "text"
)
# Apply the Likert scale sentiment codebook
likert_result <- qlm_code(texts, codebook = likert_sentiment,
                          model = "openai/gpt-4o",
                          temperature = 0)
```
```{r display_results_likert, echo = FALSE}
# sentiment analysis results table
library(kableExtra)
likert_result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3) 
```
In this way, you can easily adapt the sentiment analysis task to fit your specific research needs!
