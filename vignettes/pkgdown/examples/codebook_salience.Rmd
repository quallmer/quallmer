---
title: "Example: Salience of topics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The `qlm_code()` function with the built-in `codebook_salience()` codebook can be used to identify and rank the salience of topics discussed in texts. In this example, we will demonstrate how to apply this codebook to a sample corpus of innaugural speeches from US presidents.

### Loading packages and data

```{r getting-started}
# We will use the quanteda package 
# for loading a sample corpus of innaugural speeches
# If you have not yet installed the quanteda package, you can do so by:
# install.packages("quanteda")
library(quanteda)
library(quallmer)

# For educational purposes, 
# we will use a subset of the inaugural speeches corpus
# The three most recent speeches in the corpus
data_corpus_inaugural <- quanteda::data_corpus_inaugural[57:60]

```
### Using `qlm_code()` for salience of ANY topics discussed in texts
```{r salience}

# Apply built-in salience codebook with codebook_salience() in the qlm_code() function
result <- qlm_code(data_corpus_inaugural, codebook = codebook_salience(),
                   model = "openai/gpt-4o",
                   temperature = 0)
```
```{r display_results, echo = FALSE}
# results table
library(kableExtra)
result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3)
```
### Using `qlm_code()` for salience of a SPECIFIED LIST of topics discussed in texts
```{r salience2}

# Define a list of topics to focus on
topics <- c("economy", "health", "education", "environment", "foreign policy")
# Apply built-in salience codebook with codebook_salience() in the qlm_code() function
result <- qlm_code(data_corpus_inaugural, codebook = codebook_salience(topics),
                   model = "openai/gpt-4o",
                   temperature = 0)
```
```{r display_results2, echo = FALSE}
# results table
library(kableExtra)
result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3)
```

### Adjusting the codebook_salience() so it also returns the stance for each topic
```{r custom_task}
# Customizing the codebook to include the stance for each topic
custom_codebook <- qlm_codebook(
  name = "Salience and stance of topics",
  instructions = paste(
    "Task:",
    "- Read the text carefully.",
    "- Identify and rank the salience of the following topics: economy, health, education, environment, foreign policy.",
    "- For each topic mentioned, assign a stance as one of the following:",
    "  pro, neutral, or contra.",
    "- Append the stance directly after each topic name in the form 'topic: stance'.",
    "- Return all topic:stance entries in descending order of salience.",
    "- Separate entries with commas when presenting them in a list.",
    "",
    "Do not infer information that is not in the text.",
    "Base all evaluations solely on the language and arguments in the document.",
    "",
    "Output:",
    "- `topic_stance`: a ranked list of topic labels with stance labels appended (e.g., 'economy: pro', 'health: contra').",
    "- `explanation`: a brief justification explaining why the topics were ordered and how stance was determined.",
    sep = "\n"
  ),
  schema = ellmer::type_object(
    topic_stance = ellmer::type_array(
      ellmer::type_string("Topic and stance label combined (e.g., 'economy: pro'), ranked by salience.")
    ),
    explanation = ellmer::type_string(
      "Brief justification for the salience ordering and stance classification."
    )
  ),
  role = "You are an expert analysing the content of texts.",
  input_type = "text"
)

# Apply the customized codebook in the qlm_code() function
custom_result <- qlm_code(data_corpus_inaugural, codebook = custom_codebook,
                   model = "openai/gpt-4o",
                   temperature = 0)
```
```{r display_custom_results, echo = FALSE}
# custom results table
library(kableExtra)
custom_result %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(3)
```
In this example, we demonstrated how to use the `codebook_salience()` codebook for identifying and ranking topics discussed in texts, both with and without a specified list of topics. Additionally, we showed how to customize the codebook to include stance classification for each topic. This showcases the flexibility of the `qlm_code()` function and the `qlm_codebook()` framework in `quallmer` for various text analysis tasks.
