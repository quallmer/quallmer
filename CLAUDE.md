# Claude Code Guidelines for quallmer

## Project Overview

quallmer is an R package for qualitative data annotation and validation.
It provides: -
[`annotate()`](https://seraphinem.github.io/quallmer/reference/annotate.md):
Core function for LLM-powered text annotation - `validate_app()`: Shiny
application for validating annotations against gold standards -
Integration with the ellmer framework for LLM interactions

## Key Development Commands

**General Advice:** - Run R with `R --quiet --vanilla` for clean,
reproducible sessions - Always run `devtools::document()` after
modifying roxygen2 comments - All new code requires accompanying tests

### Testing

- Test files follow pattern: `tests/testthat/test-{name}.R` maps to
  `R/{name}.R`
- Run all tests: `devtools::test(reporter = "check")`
- Run specific tests:
  `devtools::test(filter = "name", reporter = "check")`
- **Avoid** `devtools::test_active_file()` - prefer full test suite
- Place new tests near similar existing tests
- Check coverage: `covr::package_coverage()`

### Documentation

- Run `devtools::document()` after modifying roxygen2 comments
- Every user-facing function needs `@export` and complete roxygen2
  documentation
- Add new documentation topics to `_pkgdown.yml`
- Verify with
  [`pkgdown::check_pkgdown()`](https://pkgdown.r-lib.org/reference/check_pkgdown.html)
- Use sentence case for headings in documentation
- Update NEWS.md with user-facing changes following tidyverse style

### Building and Checking

``` bash
# Build tarball
R CMD build .

# Check as CRAN
R CMD check quallmer_*.tar.gz --as-cran
```

### Website

``` r
pkgdown::build_site()     # Build/update website in docs/
pkgdown::check_pkgdown()  # Validate pkgdown configuration
```

### Running the Shiny App

``` r
quallmer::validate_app()  # Launch validation interface
```

## Project Structure & Modules

- **R/**: Package source code (e.g., `annotate.R`, `validate_app.R`,
  `task_*.R`)
- **tests/testthat/**: Unit tests using testthat edition 3
- **tests/testthat.R**: Test runner
- **man/**: Auto-generated documentation via roxygen2 (do not edit
  manually)
- **vignettes/**: Package vignettes and long-form documentation
- **data/**: Example datasets (e.g., `baker`, `druguse`)
- **data_creation/**: Scripts for generating package datasets
- \*\*\_pkgdown.yml, docs/\*\*: pkgdown website configuration and built
  site
- **DESCRIPTION**: Package metadata and dependencies
- **NAMESPACE**: Auto-generated by roxygen2
- **.github/workflows/**: GitHub Actions for CI/CD

## Coding Conventions

### Code Style

- **Indentation**: 2 spaces (no tabs)
- **Line length**: Keep reasonable; avoid overly long lines
- **Naming**: snake_case for all functions, arguments, and objects
  - Examples:
    [`trail_settings()`](https://seraphinem.github.io/quallmer/reference/trail_settings.md),
    `task_sentiment()`, `gold_standard`
- **Organization**: Newspaper-style - high-level functions first,
  helpers below
- **Nested functions**: Avoid nested function definitions (except
  trivial lambdas)
- **Imports**: Use namespace-qualified calls:
  [`dplyr::mutate()`](https://dplyr.tidyverse.org/reference/mutate.html),
  [`cli::cli_abort()`](https://cli.r-lib.org/reference/cli_abort.html)
- **File endings**: Ensure that source files end with a trailing newline

### Error Messages

- Use
  [`cli::cli_abort()`](https://cli.r-lib.org/reference/cli_abort.html)
  for all user-facing errors (never
  [`stop()`](https://rdrr.io/r/base/stop.html))
- Follow tidyverse error style guidelines:
  - Clear, actionable messages that tell users what went wrong and how
    to fix it
  - Use `{variable}` interpolation for values
  - Bullet points (`*`, `i`, `x`) for structured messages
- See `R/annotate.R` for input validation examples

### Documentation

- Use roxygen2 for all exported functions
- Include complete `@param` and `@return` documentation
- Add `@export` for user-facing APIs
- Add `@examples` where appropriate (use `\dontrun{}` for examples
  requiring API keys)
- Document all user-facing functions, even internal helpers that users
  might see

## ellmer Integration

quallmer builds on the ellmer framework. Key points: - Use ellmer’s
`chat()` and `turn()` for LLM interactions - Follow ellmer conventions
for model configuration and API usage - Maintain compatibility with
ellmer’s streaming and async features

## Testing Guidelines

### Framework and Workflow

- testthat edition 3
- File naming: `tests/testthat/test-{name}.R` maps to `R/{name}.R`
- **All new code requires accompanying tests**
- Place new tests near similar existing tests

### Running Tests

- Run all tests: `devtools::test(reporter = "check")`
- Run specific tests:
  `devtools::test(filter = "name", reporter = "check")`
- **Avoid** `devtools::test_active_file()` - always run full test suite
- Check coverage: `covr::package_coverage()`

### Testing Principles

- Write focused, atomic tests for each function
- Mock external services (LLM APIs) - no network calls in unit tests
- Use test fixtures from `tests/testthat/fixtures/` when needed
- Test edge cases, error conditions, and typical usage patterns
- Tests should be fast and deterministic

### CI/CD

- GitHub Actions run R CMD check on multiple platforms (Linux, macOS,
  Windows)
- Code coverage tracked and reported via Codecov
- pkgdown site built and deployed automatically on push to main

## Git Workflow

### Commits

- Use imperative mood: “Add feature” not “Added feature”

- Keep subject line concise (50 chars or less)

- Reference issues when applicable: “Fixes \#21”, “Closes \#45”

- Include Claude Code attribution when appropriate:

      Add trail comparison summary

      Generated with Claude Code

      Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>

### Pull Requests

Use `.github/pull_request_template.md` to structure PRs. Include: -
**Clear summary**: What does this PR do? - **Motivation**: Why is this
change needed? - **Scope**: What files/functions are affected? -
**Tests**: Add tests for new behavior - **Documentation**: Update man
pages, vignettes, or README as needed - **NEWS**: Add bullet to NEWS.md
for user-facing changes - **Screenshots**: For UI changes to
`validate_app()`, include before/after screenshots

### NEWS.md Entries

Follow tidyverse style: - One bullet per user-facing change - Use code
font for functions: `` `annotate()` `` - Reference issues/PRs and
contributors: `(#123, @username)` - Examples: -
`` `annotate()` now supports custom system prompts (#45). `` -
`` Fixed error in `validate_app()` when gold column is missing (#67). `` -
`Documentation: Added "Custom tasks" vignette (#78).`

## File Locations

### Important Files to Know

- `R/annotate.R`: Main annotation function
- `R/validate_app.R`: Shiny validation app
- `R/task_*.R`: Task definition functions (sentiment, summary, etc.)
- `R/utils.R`: Utility functions
- `tests/testthat/test-annotate.R`: Tests for annotation
- `tests/testthat/test-validate_app.R`: Tests for Shiny app
- `vignettes/quallmer.Rmd`: Main package vignette

### Configuration Files

- `.Rbuildignore`: Files/patterns to exclude from R CMD build
- `_pkgdown.yml`: Website structure and appearance
- `.github/workflows/`: CI configuration

## Security & Best Practices

### API Keys

- Never commit API keys or tokens
- Use environment variables: `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`
- Document API key setup in vignettes/README
- CI uses repository secrets for automated builds

### Reproducibility

- Use `R --quiet --vanilla` for clean R sessions
- Include [`sessionInfo()`](https://rdrr.io/r/utils/sessionInfo.html)
  when reporting issues
- Pin package versions when needed for reproducibility

## Common Tasks

### Adding a New Task Type

1.  Create `R/task_newtype.R` with roxygen docs
2.  Add `tests/testthat/test-task_newtype.R`
3.  Document in appropriate vignette
4.  Update `_pkgdown.yml` reference section
5.  Add NEWS.md entry
6.  Run `devtools::document()` and `devtools::check()`

### Updating the Shiny App

1.  Modify `R/validate_app.R`
2.  Test interactively with `quallmer::validate_app()`
3.  Add tests in `tests/testthat/test-validate_app.R`
4.  Take before/after screenshots for PR
5.  Document UI changes in NEWS.md

### Fixing a Bug

1.  Write a failing test that reproduces the bug
2.  Fix the bug in the source code
3.  Verify test now passes
4.  Add NEWS.md entry with issue reference
5.  Create PR linking to the issue

## Resources

- [R Packages (2e)](https://r-pkgs.org/): Comprehensive guide to R
  package development
- [tidyverse style guide](https://style.tidyverse.org/): Coding style
  conventions
- [testthat documentation](https://testthat.r-lib.org/): Testing
  framework
- [pkgdown documentation](https://pkgdown.r-lib.org/): Website
  generation
- [ellmer documentation](https://ellmer.tidyverse.org/): LLM integration
  framework
- [quallmer
  documentation](https://seraphinem.github.io/quallmer/index.html)

## General attitude

If I suggest a change, think about it critically, don’t just tell me
that it is a great or brilliant improvement and start trying to
implement it. Not all of my suggestions will be great.
